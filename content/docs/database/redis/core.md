+++
title = 'Redis核心知识'
date = 2024-02-19T11:53:59+08:00
draft = false

+++

# 核心知识

## 持久化

redis 提供了两种持久化的方式，分别是RDB（Redis DataBase）和AOF（Append Only File）。

RDB，简而言之，就是在不同的时间点，将 redis 存储的数据生成快照并存储到磁盘等介质上；

AOF，则是换了一个角度来实现持久化，那就是将 redis 执行过的所有写指令记录下来，在下次 redis 重新启动时，只要把这些写指令从前到后再重复执行一遍，就可以实现数据恢复了。

其实 RDB 和 AOF 两种方式也可以同时使用，在这种情况下，如果 redis 重启的话，则会优先采用 AOF 方式来进行数据恢复，这是因为 AOF 方式的数据恢复完整度更高。

如果你没有数据持久化的需求，也完全可以关闭 RDB 和 AOF 方式，这样的话，redis 将变成一个纯内存数据库，就像 memcache 一样。

### RDB

RDB 是将redis的某一时刻的数据持久化到磁盘中，是一种快照式的持久化方法。

redis在进行数据持久化的过程中，会先将数据写入到一个临时文件中，待持久化过程完成，才会将此文件替换为最终的持久化文件。

对于 RDB 模式，redis会单独创建一个子进程进行持久化操作，不会有主进程介入，从而保证redis的性能。

如果需要进行大规模的数据存储与恢复，那么 RDB 方式是当仁不让的，不过 RDB 的缺点也较为明显：
- 在redis中，RDB 是默认开启的，默认为每 900 秒内1 次修改、300 秒内 10 此修改、60 秒内 10000次修改进行一次 RDB 备份操作（可以通过`save 900 1`的方式修改频率），当redis故障时，根据备份的时间点，总会可能存在数据的丢失。
- save 频率较高时，频繁写入磁盘，会造成磁盘压力过大，同时多个子进程之间相互竞争服务器 CPU、磁盘资源。
- 虽然 RDB 备份是通过子进程实现，但如果频繁主进程创建子进程进行操作，也会对主进程造成阻塞。



### AOF

上面提到 RDB 模式不可避免会存在数据丢失的情况，对于解决这一问题，可以使用 AOF 备份方式，AOF 是将redis执行过程的指令都记录下来，在数据恢复时，按照从前到后的顺序再将指令执行一次。

在redis中，通过修改`appendonly yes`配置可打开 AOF 备份。

在redis中，AOF 的持久化策略有三种：
- Everysec，每秒写回，redis默认的配置，每秒执行一次fsync(fsync是指吧缓存中的写指令记录到磁盘中)，所以即使redis故障，也只会丢失 1 秒钟的数据。
- Always，同步写回，每次执行命令都需要执行fsync，对redis性能影响较大。
- No，操作系统控制写回，这一方式性能较高，但是宕机时丢失数据可能较多。

由于 AOF 是追加日志的方式，如果不做干预的话，AOF 文件将会越来越大，备份恢复时间也会越来越长，对于这个问题，redis提供了 AOF 文件重写机制，当 AOF 文件的大小超过设定的阈值时，redis 会对AOF文件的内容进行压缩，只保留恢复数据的最小指令集。

AOF 文件压缩示例：用户调用了 100 次 INCR 指令，此时进行压缩后，只会存在一个 SET 指令。

![211708485623912.png](https://jlhblog.oss-cn-beijing.aliyuncs.com/images/2024/2/211708485623912.png)

在重写时，如果有新的操作，redis会讲新的操作记录到新的日志文件中，待重写完成再对文件进行合并操作。

### 混合模式

从redis4.0开始支持混合型持久化模式。在 4.0 时提出创建一个同时包含rdb数据和aof数据的文件（其中rdb数据在前，aof数据在后）用于存储服务器开始执行重写操作时的数据库状态。

混合模式下，内存快照以一定频率进行，然后在两次快照之间，使用aof日志记录两次快照期间所有的命令操作。

在混合模式下，既能享受 RDB 文件快速恢复的好处，也能享受到 AOF 只记录操作命令的简单优势。

在redis4.0时，需要通过`aof-use-rdb-preamble yes`配置开启混合模式，但是在redis5.0时，redis已经将混合模式设置为默认的持久化方案。

### 持久化恢复

对于 RDB 和 AOF 而言，持久化的恢复较为简单。


在加入混合模式后，持久化的恢复，需要同时兼顾 RDB 与 AOF，混合模式的恢复流程如下：

![211708495370043.png](https://static.jiangliuhong.top/images/2024/2/211708495370043.png)

## 发布订阅

TODO

基于频道

基于模式

## 事件机制

redis事件包含两部分：

- 文件事件：用于处理 Redis 服务器和客户端之间的网络IO。
- 时间事件：Redis 服务器中的一些操作（比如serverCron函数）需要在给定的时间点执行，而时间事件就是处理这类定时操作的。


## 事务

redis 事务的本质是一组命令的集合。事务支持一次执行多个命令，一个事务中所有命令都会被序列化。在事务执行过程，会按照顺序串行化执行队列中的命令，其他客户端提交的命令请求不会插入到事务执行命令序列中。

redis事务就是一次性、顺序性、排他性的执行一个队列中的一系列命令。

redis事务相关的命令：

- MULTI ：开启事务，redis会将后续的命令逐个放入队列中，然后使用EXEC命令来原子化执行这个命令系列。
- EXEC：执行事务中的所有操作命令。
- DISCARD：取消事务，放弃执行事务块中的所有命令。
- WATCH：监视一个或多个key,如果事务在执行前，这个key(或多个key)被其他命令修改，则事务被中断，不会执行事务中的任何命令。
- UNWATCH：取消WATCH对所有key的监视。

### CAS 操作实现乐观锁

在redis中可以使用watch命令实现cas乐观锁，利用watch的特性，首先对某个key进行watch，开启事务修改key，如果此时该key被其他客户端修改，那么当前事务将会无效，在 java中代码如下：

```java
public void delete(String key, String value) {

    jedis.watch(key);
    if (value.equals(jedis.get(key))) {
        Transaction tx = jedis.multi();
        tx.del(key);
        tx.exec();
    } else {
        jedis.unwatch();
    }

}
```

