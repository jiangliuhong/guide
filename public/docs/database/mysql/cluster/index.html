<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="
  集群配置
  #


  主从同步
  #

MySQL 官方提供的同步方案，用于将一个 MySQL 的实例同步到另一个实例中。Replication 为保证数据安全做了重要的保证，是目前运用最广的 MySQL 容灾方案。Replication 用两个或以上的实例搭建了 MySQL 主从复制集群，提供单点写入，多点读取的服务，实现了读的scale out。


  主从介绍
  #

实现原理：
在主从复制中，从库利用主库上的 binlog 进行重播，实现主从同步，复制的过程中蛀主要使用到了 dump thread，I/O thread，sql thread 这三个线程：

IO thread: 在从库执行 start slave 语句时创建，负责连接主库，请求 binlog，接收 binlog 并写入 relay-log；
dump thread：用于主库同步 binlog 给从库，负责响应从 IO thread 的请求。主库会给每个从库的连接创建一个 dump thread，然后同步 binlog 给从库；
sql thread：读取 relay log 执行命令实现从库数据的更新。

主从同步优点：

通过读写分离实现横向扩展的能力，写入和更新操作在源服务器上进行，从服务器中进行数据的读取操作，通过增大从服务器的个数，能够极大的增强数据库的读取能力；
数据安全，因为副本可以暂停复制过程，所以可以在副本上运行备份服务而不会破坏相应的源数据；
方便进行数据分析，可以在写库中创建实时数据，数据的分析操作在从库中进行，不会影响到源数据库的性能；


  配置主从同步
  #

编写启动主从集群需要的配置文件：
docker-compose.yml
version: &#39;3&#39;
services:
  mysql-master:
    restart: always 
    environment:
      - MYSQL_ROOT_PASSWORD=root
    image: &#34;mysql:8.0&#34;
    volumes:
        - ./master.cnf:/etc/mysql/my.cnf
    ports:
        - &#34;10301:3306&#34;
  mysql-slave:
    restart: always 
    image: &#34;mysql:8.0&#34;
    environment:
      - MYSQL_ROOT_PASSWORD=root
    volumes:
        - ./slave.cnf:/etc/mysql/my.cnf
    ports:
        - &#34;10302:3306&#34;
master.cnf">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/docs/database/mysql/cluster/">
  <meta property="og:site_name" content="复习吧">
  <meta property="og:title" content="集群">
  <meta property="og:description" content="集群配置 # 主从同步 # MySQL 官方提供的同步方案，用于将一个 MySQL 的实例同步到另一个实例中。Replication 为保证数据安全做了重要的保证，是目前运用最广的 MySQL 容灾方案。Replication 用两个或以上的实例搭建了 MySQL 主从复制集群，提供单点写入，多点读取的服务，实现了读的scale out。
主从介绍 # 实现原理：
在主从复制中，从库利用主库上的 binlog 进行重播，实现主从同步，复制的过程中蛀主要使用到了 dump thread，I/O thread，sql thread 这三个线程：
IO thread: 在从库执行 start slave 语句时创建，负责连接主库，请求 binlog，接收 binlog 并写入 relay-log； dump thread：用于主库同步 binlog 给从库，负责响应从 IO thread 的请求。主库会给每个从库的连接创建一个 dump thread，然后同步 binlog 给从库； sql thread：读取 relay log 执行命令实现从库数据的更新。 主从同步优点：
通过读写分离实现横向扩展的能力，写入和更新操作在源服务器上进行，从服务器中进行数据的读取操作，通过增大从服务器的个数，能够极大的增强数据库的读取能力； 数据安全，因为副本可以暂停复制过程，所以可以在副本上运行备份服务而不会破坏相应的源数据； 方便进行数据分析，可以在写库中创建实时数据，数据的分析操作在从库中进行，不会影响到源数据库的性能； 配置主从同步 # 编写启动主从集群需要的配置文件：
docker-compose.yml
version: &#39;3&#39; services: mysql-master: restart: always environment: - MYSQL_ROOT_PASSWORD=root image: &#34;mysql:8.0&#34; volumes: - ./master.cnf:/etc/mysql/my.cnf ports: - &#34;10301:3306&#34; mysql-slave: restart: always image: &#34;mysql:8.0&#34; environment: - MYSQL_ROOT_PASSWORD=root volumes: - ./slave.cnf:/etc/mysql/my.cnf ports: - &#34;10302:3306&#34; master.cnf">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
    <meta property="article:published_time" content="2024-02-03T03:03:59+08:00">
    <meta property="article:modified_time" content="2024-02-07T22:38:36+08:00">
<title>集群 | 复习吧</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" >
<link rel="stylesheet" href="/book.min.cdf2dd29f013b9b416743e9529e3db831a1462598e2803454998241de8e37466.css" integrity="sha256-zfLdKfATubQWdD6VKePbgxoUYlmOKANFSZgkHejjdGY=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.80ca7f71d8159d5795f243152f289067a8e79866a78fb2aad41736a324b0b3da.js" integrity="sha256-gMp/cdgVnVeV8kMVLyiQZ6jnmGanj7Kq1Bc2oySws9o=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>复习吧</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  <ul>
<li>数据库
<ul>
<li><a href="/docs/database/mysql/">MySQL</a>
<ul>
<li><a href="/docs/database/mysql/indexes/">索引</a></li>
<li><a href="/docs/database/mysql/trans/">事务</a></li>
<li><a href="/docs/database/mysql/storage/">数据存储</a></li>
<li><a href="/docs/database/mysql/cluster/"class=active>集群</a></li>
<li><a href="/docs/database/mysql/normal/">常见面试题</a></li>
</ul>
</li>
<li>NOSQL 数据库
<ul>
<li><a href="/docs/database/redis/">Redis</a>
<ul>
<li><a href="/docs/database/redis/base/">基础概念</a></li>
<li><a href="/docs/database/redis/data/">数据结构</a></li>
<li><a href="/docs/database/redis/high/">高可用</a></li>
<li><a href="/docs/database/redis/apply/">应用实践</a></li>
</ul>
</li>
<li><a href="/docs/database/es/">ElastiSearch</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/docs/java/">Java</a></li>
<li>算法
<ul>
<li><a href="/docs/arithmetic/data/">数据结构</a></li>
</ul>
</li>
<li>中间件
<ul>
<li><a href="/docs/middleware/messagequeue/">消息队列</a></li>
</ul>
</li>
</ul>










</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>集群</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#主从同步">主从同步</a>
      <ul>
        <li><a href="#主从介绍">主从介绍</a></li>
        <li><a href="#配置主从同步">配置主从同步</a></li>
      </ul>
    </li>
    <li><a href="#springboot-配置mysql主从集群">springboot 配置mysql主从集群</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="集群配置">
  集群配置
  <a class="anchor" href="#%e9%9b%86%e7%be%a4%e9%85%8d%e7%bd%ae">#</a>
</h1>
<h2 id="主从同步">
  主从同步
  <a class="anchor" href="#%e4%b8%bb%e4%bb%8e%e5%90%8c%e6%ad%a5">#</a>
</h2>
<p>MySQL 官方提供的同步方案，用于将一个 MySQL 的实例同步到另一个实例中。Replication 为保证数据安全做了重要的保证，是目前运用最广的 MySQL 容灾方案。Replication 用两个或以上的实例搭建了 MySQL 主从复制集群，提供单点写入，多点读取的服务，实现了读的<code>scale out</code>。</p>
<p><img src="https://static.jiangliuhong.top/images/2024/2/3mysql-master-slave.png" alt="3mysql-master-slave.png" /></p>
<h3 id="主从介绍">
  主从介绍
  <a class="anchor" href="#%e4%b8%bb%e4%bb%8e%e4%bb%8b%e7%bb%8d">#</a>
</h3>
<p>实现原理：</p>
<p>在主从复制中，从库利用主库上的 binlog 进行重播，实现主从同步，复制的过程中蛀主要使用到了 dump thread，I/O thread，sql thread 这三个线程：</p>
<ul>
<li>IO thread: 在从库执行 start slave 语句时创建，负责连接主库，请求 binlog，接收 binlog 并写入 relay-log；</li>
<li>dump thread：用于主库同步 binlog 给从库，负责响应从 IO thread 的请求。主库会给每个从库的连接创建一个 dump thread，然后同步 binlog 给从库；</li>
<li>sql thread：读取 relay log 执行命令实现从库数据的更新。</li>
</ul>
<p>主从同步优点：</p>
<ol>
<li>通过读写分离实现横向扩展的能力，写入和更新操作在源服务器上进行，从服务器中进行数据的读取操作，通过增大从服务器的个数，能够极大的增强数据库的读取能力；</li>
<li>数据安全，因为副本可以暂停复制过程，所以可以在副本上运行备份服务而不会破坏相应的源数据；</li>
<li>方便进行数据分析，可以在写库中创建实时数据，数据的分析操作在从库中进行，不会影响到源数据库的性能；</li>
</ol>
<h3 id="配置主从同步">
  配置主从同步
  <a class="anchor" href="#%e9%85%8d%e7%bd%ae%e4%b8%bb%e4%bb%8e%e5%90%8c%e6%ad%a5">#</a>
</h3>
<p>编写启动主从集群需要的配置文件：</p>
<p><strong>docker-compose.yml</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">mysql-master</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">MYSQL_ROOT_PASSWORD=root</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#e6db74">&#34;mysql:8.0&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">./master.cnf:/etc/mysql/my.cnf</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#34;10301:3306&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">mysql-slave</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#e6db74">&#34;mysql:8.0&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">MYSQL_ROOT_PASSWORD=root</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">./slave.cnf:/etc/mysql/my.cnf</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#e6db74">&#34;10302:3306&#34;</span>
</span></span></code></pre></div><p><strong>master.cnf</strong></p>
<pre tabindex="0"><code>[mysqld]
server-id=10
# 开启 binlog
log_bin=master-bin
log_bin-index=master-bin.index
# 允许最大连接数
max_connections=200
# 允许连接失败的次数
max_connect_errors=10
# 服务端使用的字符集默认为UTF8
character-set-server=utf8
# 创建新表时将使用的默认存储引擎
default-storage-engine=INNODB
</code></pre><p><strong>slave.cnf</strong></p>
<pre tabindex="0"><code>[mysqld]
# 主库和从库需要不一致
server-id=11
# 打开MySQL中继日志
relay-log-index=slave-relay-bin.index
relay-log=slave-relay-bin
# 打开从服务二进制日志
log-bin=mysql-bin
# 使得更新的数据写进二进制日志中
log-slave-updates=1
# 允许最大连接数
max_connections=200
# 允许连接失败的次数
max_connect_errors=10
# 服务端使用的字符集默认为UTF8
character-set-server=utf8
# 创建新表时将使用的默认存储引擎
default-storage-engine=INNODB
</code></pre><p>拉起服务后，进入主节点容器，创建用于同步的账号：</p>
<pre tabindex="0"><code>CREATE USER &#39;slave&#39;@&#39;%&#39; IDENTIFIED BY &#39;password&#39;;

GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO &#39;slave&#39;@&#39;%&#39;;
</code></pre><p>查看主节点状态：</p>
<pre tabindex="0"><code>show master status;
</code></pre><p>进入从节点容器，执行命令，链接主节点:</p>
<pre tabindex="0"><code>CHANGE MASTER TO master_host = &#39;mysql-master&#39;,
master_user = &#39;slave&#39;,
master_password = &#39;password&#39;,
master_port = 3306,
master_log_file = &#39;master-bin.000003&#39;,
master_log_pos = 712,
master_connect_retry = 30;
</code></pre><p><strong>注意:</strong></p>
<ul>
<li><code>master_host</code>为docker容器的名称，如果不是使用的docker部署，需要改为实际的主节点ip。</li>
<li><code>master_log_file</code>与<code>master_log_pos</code>的值来源于<code>show master status</code>的执行结果。</li>
</ul>
<p>启动主从同步：<code>start salve</code> （对应的停止同步为<code>stop salve</code>）。</p>
<p>查看从节点状态：</p>
<pre tabindex="0"><code>show slave status \G;
</code></pre><p>打印如下则代表启动成功（启动失败时，会打印响应的错如日志，根据日志进行解决即可）：</p>
<pre tabindex="0"><code>Slave_IO_Running: Yes
Slave_SQL_Running: Yes
</code></pre><p>测试主从同步，在主节点执行命令：</p>
<pre tabindex="0"><code>create database testdb;
use testdb;
create table t_user(id int,name varchar(200),primary key(id));
insert into t_user (1,&#39;name&#39;);
</code></pre><p>在从节点执行查询sql:</p>
<pre tabindex="0"><code>select * from t_user;
</code></pre><p>执行结果如下，证明主从同步配置成功：</p>
<pre tabindex="0"><code>+----+------+
| id | name |
+----+------+
|  1 | name |
+----+------+
1 row in set (0.00 sec)
</code></pre><h2 id="springboot-配置mysql主从集群">
  springboot 配置mysql主从集群
  <a class="anchor" href="#springboot-%e9%85%8d%e7%bd%aemysql%e4%b8%bb%e4%bb%8e%e9%9b%86%e7%be%a4">#</a>
</h2>
<p>源码参考：<a href="https://github.com/jiangliuhong/olcp/blob/master/olcp-common/olcp-common-db/src/main/java/top/jiangliuhong/olcp/common/DatasourceClusterConfig.java">https://github.com/jiangliuhong/olcp/blob/master/olcp-common/olcp-common-db/src/main/java/top/jiangliuhong/olcp/common/DatasourceClusterConfig.java</a></p>
<p><strong>定义动态切换的数据源</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RoutingDataSource</span> <span style="color:#66d9ef">extends</span> AbstractRoutingDataSource {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> Object <span style="color:#a6e22e">determineCurrentLookupKey</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ClusterDBContext.<span style="color:#a6e22e">get</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>创建集群数据库上下文 ClusterDBContext</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Slf4j</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClusterDBContext</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ThreadLocal<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> dbContext <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadLocal<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> AtomicInteger counter <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AtomicInteger(<span style="color:#f92672">-</span>1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Map<span style="color:#f92672">&lt;</span>Object, Object<span style="color:#f92672">&gt;</span> dataSources <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> masterKeys <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> slaveKeys <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">registry</span>(String key, Object obj) {
</span></span><span style="display:flex;"><span>        dataSources.<span style="color:#a6e22e">put</span>(key, obj);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (StringUtils.<span style="color:#a6e22e">startsWith</span>(key, <span style="color:#e6db74">&#34;master&#34;</span>)) {
</span></span><span style="display:flex;"><span>            masterKeys.<span style="color:#a6e22e">add</span>(key);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            slaveKeys.<span style="color:#a6e22e">add</span>(key);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Object <span style="color:#a6e22e">getDefaultMaster</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (masterKeys.<span style="color:#a6e22e">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException(<span style="color:#e6db74">&#34;not found master datasource&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> dataSources.<span style="color:#a6e22e">get</span>(masterKeys.<span style="color:#a6e22e">get</span>(0));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">set</span>(String dbType) {
</span></span><span style="display:flex;"><span>        dbContext.<span style="color:#a6e22e">set</span>(dbType);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> String <span style="color:#a6e22e">get</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> dbContext.<span style="color:#a6e22e">get</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">master</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> index <span style="color:#f92672">=</span> counter.<span style="color:#a6e22e">getAndIncrement</span>() <span style="color:#f92672">%</span> masterKeys.<span style="color:#a6e22e">size</span>();
</span></span><span style="display:flex;"><span>        String slaveKey <span style="color:#f92672">=</span> masterKeys.<span style="color:#a6e22e">get</span>(index);
</span></span><span style="display:flex;"><span>        log.<span style="color:#a6e22e">debug</span>(<span style="color:#e6db74">&#34;change master datasource ,use {}&#34;</span>, slaveKey);
</span></span><span style="display:flex;"><span>        set(slaveKey);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">slave</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (slaveKeys.<span style="color:#a6e22e">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>            log.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;not found slave datasource,use master&#34;</span>);
</span></span><span style="display:flex;"><span>            master();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//  读库负载均衡(轮询方式)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> index <span style="color:#f92672">=</span> counter.<span style="color:#a6e22e">getAndIncrement</span>() <span style="color:#f92672">%</span> slaveKeys.<span style="color:#a6e22e">size</span>();
</span></span><span style="display:flex;"><span>        String slaveKey <span style="color:#f92672">=</span> slaveKeys.<span style="color:#a6e22e">get</span>(index);
</span></span><span style="display:flex;"><span>        log.<span style="color:#a6e22e">debug</span>(<span style="color:#e6db74">&#34;change slave datasource ,use {}&#34;</span>, slaveKey);
</span></span><span style="display:flex;"><span>        set(slaveKey);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>创建springboot自动装配类</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Setter</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConfigurationProperties</span>(prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;spring.datasource&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConditionalOnProperty</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;spring.datasource.enable-cluster&#34;</span>, havingValue <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;true&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DatasourceClusterConfig</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Map<span style="color:#f92672">&lt;</span>String, DataSourceProperties<span style="color:#f92672">&gt;</span> cluster <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>DataSource<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">dataSources</span>(<span style="color:#a6e22e">@Autowired</span> DataSourceProperties dataSourceProperties) {
</span></span><span style="display:flex;"><span>        List<span style="color:#f92672">&lt;</span>DataSource<span style="color:#f92672">&gt;</span> list <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 处理默认的master datasource</span>
</span></span><span style="display:flex;"><span>        ClusterDBContext.<span style="color:#a6e22e">registry</span>(<span style="color:#e6db74">&#34;master0&#34;</span>, createDataSource(dataSourceProperties));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">cluster</span>.<span style="color:#a6e22e">forEach</span>((key, val) <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>            DataSource dataSource2 <span style="color:#f92672">=</span> createDataSource(val);
</span></span><span style="display:flex;"><span>            ClusterDBContext.<span style="color:#a6e22e">registry</span>(key, dataSource2);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> list;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> DataSource <span style="color:#a6e22e">createDataSource</span>(DataSourceProperties properties) {
</span></span><span style="display:flex;"><span>        DriverManagerDataSource dataSource <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> DriverManagerDataSource();
</span></span><span style="display:flex;"><span>        dataSource.<span style="color:#a6e22e">setUrl</span>(properties.<span style="color:#a6e22e">getUrl</span>());
</span></span><span style="display:flex;"><span>        dataSource.<span style="color:#a6e22e">setUsername</span>(properties.<span style="color:#a6e22e">getUsername</span>());
</span></span><span style="display:flex;"><span>        dataSource.<span style="color:#a6e22e">setPassword</span>(properties.<span style="color:#a6e22e">getPassword</span>());
</span></span><span style="display:flex;"><span>        dataSource.<span style="color:#a6e22e">setDriverClassName</span>(properties.<span style="color:#a6e22e">getDriverClassName</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> dataSource;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Primary</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@DependsOn</span>(<span style="color:#e6db74">&#34;dataSources&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> DataSource <span style="color:#a6e22e">routingDataSource</span>() {
</span></span><span style="display:flex;"><span>        RoutingDataSource routingDataSource <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RoutingDataSource();
</span></span><span style="display:flex;"><span>        routingDataSource.<span style="color:#a6e22e">setDefaultTargetDataSource</span>(ClusterDBContext.<span style="color:#a6e22e">getDefaultMaster</span>());
</span></span><span style="display:flex;"><span>        routingDataSource.<span style="color:#a6e22e">setTargetDataSources</span>(ClusterDBContext.<span style="color:#a6e22e">dataSources</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> routingDataSource;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> DataSourceAop <span style="color:#a6e22e">dataSourceAop</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> DataSourceAop();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>通过以上配置，在springboot启动的时候，会将routingDataSource作为默认的datasource运行。</p>
<p>为达到动态切换数据源的目录，可以有两种方式：</p>
<ul>
<li>通过切面，自动对查询类、修改类方法自动切换数据源</li>
<li>定义 @Master 注解，所有被该注解修饰的类均使用master数据源</li>
</ul>
<p><strong>定义@Master</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">@interface</span> Master {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>定义切面</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Aspect</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DataSourceAop</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Pointcut</span>(<span style="color:#e6db74">&#34;@annotation(top.jiangliuhong.olcp.common.annos.Master) &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;|| execution(* top.jiangliuhong.olcp.*.service..*.insert*(..)) &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;|| execution(* top.jiangliuhong.olcp.*.service..*.save*(..)) &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;|| execution(* top.jiangliuhong.olcp.*.service..*.add*(..)) &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;|| execution(* top.jiangliuhong.olcp.*.service..*.update*(..)) &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;|| execution(* top.jiangliuhong.olcp.*.service..*.edit*(..)) &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;|| execution(* top.jiangliuhong.olcp.*.service..*.delete*(..)) &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;|| execution(* top.jiangliuhong.olcp.*.service..*.remove*(..))&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">writePointcut</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Pointcut</span>(<span style="color:#e6db74">&#34;!@annotation(top.jiangliuhong.olcp.common.annos.Master) &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;&amp;&amp; (execution(* top.jiangliuhong.olcp.*.service..*.select*(..)) &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;|| execution(* top.jiangliuhong.olcp.*.service..*.query*(..)) &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;|| execution(* top.jiangliuhong.olcp.*.service..*.get*(..)))&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">readPointcut</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Before</span>(<span style="color:#e6db74">&#34;writePointcut()&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">write</span>() {
</span></span><span style="display:flex;"><span>        ClusterDBContext.<span style="color:#a6e22e">master</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Before</span>(<span style="color:#e6db74">&#34;readPointcut()&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">read</span>() {
</span></span><span style="display:flex;"><span>        ClusterDBContext.<span style="color:#a6e22e">slave</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>数据源配置</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">datasource</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 默认的配置将作为 master0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">url</span>: <span style="color:#ae81ff">jdbc:mysql://127.0.0.1:10301/olcp?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;allowPublicKeyRetrieval=true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">username</span>: <span style="color:#ae81ff">root</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">password</span>: <span style="color:#ae81ff">root</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">driver-class-name</span>: <span style="color:#ae81ff">com.mysql.cj.jdbc.Driver</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enable-cluster</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cluster</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">master1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">url</span>: <span style="color:#ae81ff">jdbc:mysql://127.0.0.1:10302/olcp?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;allowPublicKeyRetrieval=true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">username</span>: <span style="color:#ae81ff">root</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">password</span>: <span style="color:#ae81ff">root</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">driver-class-name</span>: <span style="color:#ae81ff">com.mysql.cj.jdbc.Driver</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">slave0</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">url</span>: <span style="color:#ae81ff">jdbc:mysql://127.0.0.1:10303/olcp?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;allowPublicKeyRetrieval=true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">username</span>: <span style="color:#ae81ff">root</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">password</span>: <span style="color:#ae81ff">root</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">driver-class-name</span>: <span style="color:#ae81ff">com.mysql.cj.jdbc.Driver</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">slave2</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">url</span>: <span style="color:#ae81ff">jdbc:mysql://127.0.0.1:10303/olcp?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;allowPublicKeyRetrieval=true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">username</span>: <span style="color:#ae81ff">root</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">password</span>: <span style="color:#ae81ff">root</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">driver-class-name</span>: <span style="color:#ae81ff">com.mysql.cj.jdbc.Driver</span>
</span></span></code></pre></div><p>通过上面的切面配置，当方法名是select、query、get开头、没有被@Master修饰的方法或者是方法名不被writePointcut匹配时，将默认使用slave数据源</p>
<p>参考链接：<a href="https://zhuanlan.zhihu.com/p/80350536">https://zhuanlan.zhihu.com/p/80350536</a></p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#主从同步">主从同步</a>
      <ul>
        <li><a href="#主从介绍">主从介绍</a></li>
        <li><a href="#配置主从同步">配置主从同步</a></li>
      </ul>
    </li>
    <li><a href="#springboot-配置mysql主从集群">springboot 配置mysql主从集群</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












